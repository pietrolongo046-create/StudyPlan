<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta http-equiv="Content-Security-Policy" content="default-src 'self' ipc: http://ipc.localhost; style-src 'self' 'unsafe-inline'; font-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; img-src 'self' data:; connect-src ipc: http://ipc.localhost 'self'">
<style>
@font-face {
  font-family: 'Inter';
  font-style: normal;
  font-weight: 100 900;
  font-display: swap;
  src: url('./fonts/InterVariable.woff2') format('woff2');
}
* { margin: 0; padding: 0; box-sizing: border-box; }
html, body {
  background: transparent !important;
  height: 100%;
  overflow: hidden;
  border-radius: 22px;
}
body {
  font-family: 'Inter', sans-serif;
  background: transparent;
  color: #e8eaf0;
  overflow: hidden;
  user-select: none;
  font-size: 14px;
  cursor: default;
}
.widget {
  background: rgba(12, 13, 20, 0.94);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 22px;
  backdrop-filter: blur(40px) saturate(1.4);
  -webkit-backdrop-filter: blur(40px) saturate(1.4);
  height: 100vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  box-shadow:
    0 0 0 0.5px rgba(255,255,255,0.06),
    0 8px 40px rgba(0,0,0,0.55),
    0 2px 8px rgba(0,0,0,0.25);
}
.resize-handle {
  position: fixed; bottom: 0; right: 0;
  width: 20px; height: 20px;
  cursor: nwse-resize; -webkit-app-region: no-drag;
  z-index: 999; opacity: 0; transition: opacity 0.3s;
}
.widget:hover .resize-handle { opacity: 0.4; }
.resize-handle:hover { opacity: 0.7 !important; }
.resize-handle::after {
  content: ''; position: absolute;
  bottom: 5px; right: 5px; width: 8px; height: 8px;
  border-right: 2px solid #8b90a5; border-bottom: 2px solid #8b90a5;
  border-radius: 0 0 3px 0;
}
/* Header */
.wh {
  display: flex; align-items: center; gap: 4px;
  padding: 12px 14px 8px;
  flex-shrink: 0;
  cursor: grab;
}
.wh:active { cursor: grabbing; }
.wh-tab {
  -webkit-app-region: no-drag;
  background: none; border: none; color: #555a70;
  font: 600 13px/1 'Inter', sans-serif;
  padding: 8px 12px; border-radius: 10px;
  cursor: pointer; transition: all 0.2s ease;
  display: flex; align-items: center; gap: 5px;
  white-space: nowrap; position: relative;
}
.wh-tab:hover { color: #a0a3b5; background: rgba(255,255,255,0.04); }
.wh-tab.active {
  color: #e8eaf0; background: rgba(255,255,255,0.08);
  box-shadow: 0 1px 4px rgba(0,0,0,0.2);
}
.wh-tab.active::after {
  content: ''; position: absolute; bottom: -1px; left: 50%; transform: translateX(-50%);
  width: 14px; height: 2px; background: #8070d0; border-radius: 1px;
}
.wh-spacer { flex: 1; }
.wh-btn {
  -webkit-app-region: no-drag;
  background: none; border: none; color: #555a70;
  padding: 6px; border-radius: 8px; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.2s;
}
.wh-btn:hover { color: #f87171; background: rgba(248,113,113,0.1); transform: scale(1.1); }
/* Body */
.wb {
  flex: 1; display: flex; gap: 12px;
  padding: 6px 14px 14px; overflow: hidden; min-height: 0;
}
/* Stats sidebar */
.ws {
  display: flex; flex-direction: column; gap: 6px;
  flex-shrink: 0; width: 80px;
}
.ws-card {
  text-align: center; background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.05);
  border-radius: 12px; padding: 10px 6px; flex: 1;
  display: flex; flex-direction: column; justify-content: center;
  transition: all 0.2s ease; cursor: pointer;
  -webkit-app-region: no-drag;
}
.ws-card:hover { background: rgba(255,255,255,0.06); transform: translateY(-1px); }
.ws-val {
  font-weight: 800; line-height: 1;
  font-size: 22px;
  transition: color 0.3s;
}
.ws-lbl {
  color: #666a80; margin-top: 4px; text-transform: uppercase;
  letter-spacing: 0.4px;
  font-size: 9px;
  font-weight: 700;
}
/* Scrollable content */
.wc {
  flex: 1; overflow-y: auto; overflow-x: hidden;
  -webkit-app-region: no-drag; min-width: 0;
  scroll-behavior: smooth;
}
.wc::-webkit-scrollbar { width: 4px; }
.wc::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 2px; }
.wc::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }
/* Event items (Oggi) */
.ev {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 12px; border-radius: 12px; margin-bottom: 6px;
  background: rgba(255,255,255,0.03); transition: all 0.2s ease;
  cursor: pointer; -webkit-app-region: no-drag;
  border: 1px solid transparent;
}
.ev:hover { background: rgba(255,255,255,0.07); border-color: rgba(255,255,255,0.06); transform: translateX(2px); }
.ev-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; box-shadow: 0 0 8px currentColor; }
.ev-info { flex: 1; min-width: 0; }
.ev-name {
  font-weight: 600; font-size: 14px;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  margin-bottom: 2px;
}
.ev-name.done { text-decoration: line-through; opacity: 0.4; }
.ev-time { color: #888; font-size: 12px; font-weight: 500; }
.ev-chk {
  width: 22px; height: 22px; border: 2px solid #444860;
  border-radius: 6px; flex-shrink: 0;
  transition: all 0.2s; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
}
.ev-chk:hover { border-color: #34d399; transform: scale(1.1); }
.ev-chk.done {
  background: #34d399; border-color: #34d399;
  box-shadow: 0 0 10px rgba(52,211,153,0.4);
}
.ev-chk.done::after { content: '✓'; font-size: 12px; color: #000; font-weight: 800; }
.ev-now { border-left: 3px solid #8070d0; }
/* Week view - MUCH BIGGER */
.wk-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
.wk-day { text-align: center; }
.wk-day-hdr {
  font-weight: 700; color: #555; text-transform: uppercase;
  padding: 4px 0; font-size: 11px;
  border-bottom: 1px solid rgba(255,255,255,0.05);
}
.wk-day.today .wk-day-hdr { color: #8070d0; }
.wk-day-num {
  font-weight: 700; padding: 6px 0; font-size: 16px; color: #999;
}
.wk-day.today .wk-day-num {
  color: #fff;
}
.wk-day.today .wk-day-num span {
  background: linear-gradient(135deg, #8070d0, #6050b8);
  border-radius: 50%; width: 28px; height: 28px;
  display: inline-flex; align-items: center; justify-content: center;
  font-size: 14px;
  box-shadow: 0 2px 8px rgba(128,112,208,0.4);
}
.wk-evts { padding: 4px 2px; min-height: 50px; }
.wk-evt {
  border-radius: 6px; padding: 4px 6px; margin-bottom: 3px;
  color: #fff; cursor: pointer; -webkit-app-region: no-drag;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  font-size: 11px; font-weight: 600;
  transition: all 0.15s;
}
.wk-evt:hover { filter: brightness(1.2); transform: scale(1.02); }
.wk-evt.done-evt { opacity: 0.35; text-decoration: line-through; }
/* Exam items */
.ex {
  padding: 12px 14px; background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.05);
  border-radius: 12px; margin-bottom: 8px;
  cursor: pointer; -webkit-app-region: no-drag;
  transition: all 0.2s ease;
}
.ex:hover { background: rgba(255,255,255,0.06); transform: translateX(2px); }
.ex-top { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
.ex-name { font-weight: 700; font-size: 15px; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.ex-meta { color: #888; font-size: 12px; font-weight: 600; }
.ex-cd {
  font-weight: 700; padding: 4px 8px; border-radius: 6px;
  font-size: 11px;
}
.ex-cd.ok { background: rgba(52,211,153,0.15); color: #34d399; }
.ex-cd.warn { background: rgba(251,191,36,0.15); color: #FBBF24; }
.ex-cd.urgent { background: rgba(248,113,113,0.15); color: #f87171; animation: pulse-urgent 2s infinite; }
@keyframes pulse-urgent { 0%,100%{ opacity:1 } 50%{ opacity:0.7 } }
.ex-bar { display: flex; align-items: center; gap: 8px; }
.ex-bar-bg { flex: 1; height: 6px; background: rgba(255,255,255,0.08); border-radius: 3px; overflow: hidden; }
.ex-bar-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease; }
.ex-pct { font-weight: 700; min-width: 40px; text-align: right; font-size: 13px; }
/* Empty state */
.w-empty {
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  height: 100%; color: #555; gap: 8px; font-size: 14px;
}
.w-empty-icon { opacity: 0.5; }
.w-empty-icon svg { width: 32px; height: 32px; stroke: #8070d0; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }
.ev, .ex { animation: fadeIn 0.25s ease forwards; }
</style>
</head>
<body>
<div class="widget">
  <div class="wh">
    <button class="wh-tab active" data-tab="today">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
      Oggi
    </button>
    <button class="wh-tab" data-tab="week">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><line x1="8" y1="14" x2="8" y2="14.01"/><line x1="12" y1="14" x2="12" y2="14.01"/><line x1="16" y1="14" x2="16" y2="14.01"/><line x1="8" y1="18" x2="8" y2="18.01"/><line x1="12" y1="18" x2="12" y2="18.01"/></svg>
      Settimana
    </button>
    <button class="wh-tab" data-tab="career">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c0 2 3 3 6 3s6-1 6-3v-5"/></svg>
      Esami
    </button>
    <div class="wh-spacer"></div>
    <button class="wh-btn" onclick="closeWidget()" title="Chiudi">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </button>
  </div>
  <div class="wb">
    <div class="ws" id="wStats"></div>
    <div class="wc" id="wContent"></div>
  </div>
</div>
<div class="resize-handle"></div>
<script>
var DS = ['DOM','LUN','MAR','MER','GIO','VEN','SAB'];
var MO = ['Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'];
var CC = { lezione:'#60a5fa', studio:'#8070d0', esame:'#f87171', progetto:'#34d399', personale:'#fbbf24', pausa:'#2dd4bf' };
var activeTab = 'today';

/* ── Drag manuale via Tauri startDragging ── */
(function() {
  var header = document.querySelector('.wh');
  if (!header) return;
  header.addEventListener('mousedown', function(e) {
    // Solo click sinistro e non su bottoni/tab
    if (e.button !== 0) return;
    if (e.target.closest('.wh-tab') || e.target.closest('.wh-btn')) return;
    e.preventDefault();
    if (window.__TAURI__ && window.__TAURI__.window) {
      var currentWin = window.__TAURI__.window.getCurrentWindow();
      if (currentWin && currentWin.startDragging) {
        currentWin.startDragging();
      }
    }
  });
})();

/* ── Close widget ── */
function closeWidget() {
  try {
    // Primary: use getCurrentWindow().hide() — most reliable
    if (window.__TAURI__ && window.__TAURI__.window) {
      var currentWin = window.__TAURI__.window.getCurrentWindow();
      if (currentWin && currentWin.hide) {
        currentWin.hide();
        return;
      }
    }
  } catch(e) {}
  try {
    // Fallback: invoke toggle_widget command
    if (window.__TAURI__ && window.__TAURI__.core && window.__TAURI__.core.invoke) {
      window.__TAURI__.core.invoke('toggle_widget');
      return;
    }
  } catch(e2) {}
  // Last resort: try window.close()
  try { window.close(); } catch(e3) {}
}

document.querySelectorAll('.wh-tab').forEach(function(btn) {
  btn.addEventListener('click', function() {
    document.querySelectorAll('.wh-tab').forEach(function(b) { b.classList.remove('active'); });
    btn.classList.add('active');
    activeTab = btn.dataset.tab;
    render();
  });
});

function openApp(opts) { if (window.api && window.api.showMainWindow) window.api.showMainWindow(opts || {}); }

async function toggleEvent(eventId) {
  try {
    var events = await window.api.loadEvents();
    var ev = events.find(function(e) { return e.id === eventId; });
    if (ev) { ev.completed = !ev.completed; await window.api.saveEvents(events); render(); }
  } catch(e) {}
}

async function render() {
  if (activeTab === 'today') await renderToday();
  else if (activeTab === 'week') await renderWeek();
  else if (activeTab === 'career') await renderCareer();
}

function isNowInRange(start, end) {
  var now = new Date(), h = now.getHours(), m = now.getMinutes();
  var t = String(h).padStart(2,'0') + ':' + String(m).padStart(2,'0');
  return t >= start && t <= end;
}

async function renderToday() {
  var events = await window.api.getWidgetToday();
  var total = events.length, done = events.filter(function(e){return e.completed}).length;
  var pct = total > 0 ? Math.round(done / total * 100) : 0;
  document.getElementById('wStats').innerHTML =
    '<div class="ws-card" onclick="openApp()"><div class="ws-val">' + total + '</div><div class="ws-lbl">Impegni</div></div>' +
    '<div class="ws-card" onclick="openApp()"><div class="ws-val" style="color:#34d399">' + done + '</div><div class="ws-lbl">Fatti</div></div>' +
    '<div class="ws-card" onclick="openApp()"><div class="ws-val" style="color:' + (pct === 100 ? '#34d399' : pct > 50 ? '#fbbf24' : '#f87171') + '">' + pct + '%</div><div class="ws-lbl">Progresso</div></div>';
  var ct = document.getElementById('wContent');
  if (!events.length) { ct.innerHTML = '<div class="w-empty"><div class="w-empty-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg></div>Nessun impegno oggi!</div>'; return; }
  ct.innerHTML = events.map(function(ev) {
    var nowClass = !ev.completed && isNowInRange(ev.timeStart, ev.timeEnd) ? ' ev-now' : '';
    return '<div class="ev' + nowClass + '">' +
      '<div class="ev-dot" style="background:' + (CC[ev.category] || '#60a5fa') + ';color:' + (CC[ev.category] || '#60a5fa') + '"></div>' +
      '<div class="ev-info" onclick="openApp({navigate:{tab:\'today\',eventId:\'' + ev.id + '\'}})">' +
        '<div class="ev-name ' + (ev.completed ? 'done' : '') + '">' + ev.title + '</div>' +
        '<div class="ev-time">' + ev.timeStart + ' – ' + ev.timeEnd + '</div>' +
      '</div>' +
      '<div class="ev-chk ' + (ev.completed ? 'done' : '') + '" onclick="toggleEvent(\'' + ev.id + '\')"></div>' +
    '</div>';
  }).join('');
}

async function renderWeek() {
  var now = new Date();
  var sow = new Date(now); sow.setDate(now.getDate() - ((now.getDay() + 6) % 7));
  var todayStr = now.toISOString().split('T')[0];
  var weekEvents = await window.api.getWidgetWeek();
  var total = weekEvents.length, done = weekEvents.filter(function(e){return e.completed}).length;
  var pct = total > 0 ? Math.round(done / total * 100) : 0;
  document.getElementById('wStats').innerHTML =
    '<div class="ws-card" onclick="openApp()"><div class="ws-val">' + total + '</div><div class="ws-lbl">Totali</div></div>' +
    '<div class="ws-card" onclick="openApp()"><div class="ws-val" style="color:#34d399">' + done + '</div><div class="ws-lbl">Fatti</div></div>' +
    '<div class="ws-card" onclick="openApp()"><div class="ws-val" style="color:' + (pct === 100 ? '#34d399' : pct > 50 ? '#fbbf24' : '#f87171') + '">' + pct + '%</div><div class="ws-lbl">Sett.</div></div>';
  var ct = document.getElementById('wContent');
  var html = '<div class="wk-grid">';
  for (var i = 0; i < 7; i++) {
    var day = new Date(sow); day.setDate(sow.getDate() + i);
    var ds = day.toISOString().split('T')[0];
    var isToday = ds === todayStr;
    var di = day.getDay();
    var dayEvts = weekEvents.filter(function(e){return e.date === ds}).sort(function(a,b){return a.timeStart.localeCompare(b.timeStart)});
    html += '<div class="wk-day' + (isToday ? ' today' : '') + '">';
    html += '<div class="wk-day-hdr">' + DS[(di+7)%7] + '</div>';
    html += '<div class="wk-day-num"><span>' + day.getDate() + '</span></div>';
    html += '<div class="wk-evts">';
    dayEvts.slice(0,3).forEach(function(ev) {
      html += '<div class="wk-evt' + (ev.completed ? ' done-evt' : '') + '" onclick="openApp({navigate:{tab:\'week\'}})" style="background:' + (CC[ev.category]||'#60a5fa') + '">' + ev.title.substring(0,10) + '</div>';
    });
    if (dayEvts.length > 3) html += '<div style="font-size:10px;color:#666;text-align:center">+' + (dayEvts.length-3) + '</div>';
    html += '</div></div>';
  }
  html += '</div>';
  ct.innerHTML = html;
}

async function renderCareer() {
  var exams = await window.api.getWidgetExams();
  var career = await window.api.getWidgetCareer();
  var mediaHtml = '—', cfuDone = 0, cfuTotal = 0;
  if (career) {
    cfuTotal = career.totalCfu || 0;
    if (career.exams) {
      var passed = career.exams.filter(function(e){return e.status === 'passed'});
      cfuDone = passed.reduce(function(s,e){return s + (e.cfu||0)}, 0);
      var graded = passed.filter(function(e){return e.grade && e.grade >= 18});
      if (graded.length) {
        var sumVC = 0, sumC = 0;
        graded.forEach(function(e) { var v = e.grade === 31 ? 30 : e.grade; sumVC += v * e.cfu; sumC += e.cfu; });
        mediaHtml = (sumVC / sumC).toFixed(1);
      }
    }
  }
  var pct = cfuTotal > 0 ? Math.round(cfuDone / cfuTotal * 100) : 0;
  document.getElementById('wStats').innerHTML =
    '<div class="ws-card" onclick="openApp()"><div class="ws-val" style="color:#a78bfa">' + mediaHtml + '</div><div class="ws-lbl">Media</div></div>' +
    '<div class="ws-card" onclick="openApp()"><div class="ws-val">' + cfuDone + '</div><div class="ws-lbl">CFU</div></div>' +
    '<div class="ws-card" onclick="openApp()"><div class="ws-val" style="color:#34d399">' + pct + '%</div><div class="ws-lbl">Percorso</div></div>';
  var ct = document.getElementById('wContent');
  if (!exams.length) { ct.innerHTML = '<div class="w-empty"><div class="w-empty-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c0 2 3 3 6 3s6-1 6-3v-5"/></svg></div>Nessun esame in programma</div>'; return; }
  ct.innerHTML = exams.slice(0,5).map(function(ex) {
    var prog = ex.progress || 0;
    var pc = prog >= 80 ? '#34d399' : prog >= 50 ? '#fbbf24' : '#f87171';
    var cdHtml = '';
    if (ex.examDate) {
      var ed = new Date(ex.examDate + 'T00:00:00');
      var dd = Math.ceil((ed - new Date()) / 86400000);
      var ds = ed.getDate() + ' ' + MO[ed.getMonth()];
      var cls = dd <= 7 ? 'urgent' : dd <= 21 ? 'warn' : 'ok';
      var text = dd < 0 ? 'Passato' : dd === 0 ? 'OGGI!' : ds;
      cdHtml = '<span class="ex-cd ' + cls + '">' + text + '</span>';
    }
    return '<div class="ex" onclick="openApp({navigate:{tab:\'career\',examName:\'' + ex.name.replace(/'/g, "\\'") + '\'}})">' +
      '<div class="ex-top"><div class="ex-name">' + ex.name + '</div><span class="ex-meta">' + ex.cfu + ' CFU</span>' + cdHtml + '</div>' +
      '<div class="ex-bar"><div class="ex-bar-bg"><div class="ex-bar-fill" style="width:' + prog + '%;background:' + pc + '"></div></div><span class="ex-pct" style="color:' + pc + '">' + prog + '%</span></div>' +
    '</div>';
  }).join('');
}

render();
setInterval(render, 120000);
if (window.api && window.api.onDataChanged) { window.api.onDataChanged(function() { render(); }); }
</script>
</body>
</html>
